# RAG AI Assistant ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

RAGï¼ˆRetrieval-Augmented Generationï¼‰AI åŠ©æ‰‹å¯ä»¥è‡ªä¸»åœ°ä»å¤šä¸ªæ•°æ®æºæ£€ç´¢ä¿¡æ¯ï¼Œå¹¶åŸºäºæ£€ç´¢ç»“æœå›ç­”é—®é¢˜ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ” è‡ªä¸»æ£€ç´¢

AI ä¼šè‡ªå·±å†³å®šä½•æ—¶éœ€è¦æ£€ç´¢ä¿¡æ¯ï¼Œä»¥åŠä»å“ªé‡Œæ£€ç´¢ï¼š

1. **ç”¨æˆ·æ–°é—»åº“**ï¼ˆElasticsearchï¼‰
   - æ··åˆæœç´¢ï¼ˆå…³é”®è¯ + è¯­ä¹‰ï¼‰
   - å‘é‡ç›¸ä¼¼åº¦åŒ¹é…
   - é«˜ç›¸å…³æ€§æ’åº

2. **æœ€è¿‘æ–°é—»**ï¼ˆMongoDBï¼‰
   - æ—¶é—´èŒƒå›´è¿‡æ»¤
   - å¿«é€Ÿè®¿é—®æœ€æ–°å†…å®¹

3. **å¤–éƒ¨ç½‘ç»œ**ï¼ˆTavily APIï¼‰
   - å®æ—¶ç½‘ç»œæœç´¢
   - è·å–æœ€æ–°ä¿¡æ¯

### ğŸ¤– æ™ºèƒ½å†³ç­–

AI ä¼šæ ¹æ®é—®é¢˜ç±»å‹è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼š

```
ç”¨æˆ·é—®ï¼š"æˆ‘æœ‰å“ªäº›å…³äº AI çš„æ–°é—»ï¼Ÿ"
â†’ AI è°ƒç”¨ï¼šsearch_user_news(query="AI")

ç”¨æˆ·é—®ï¼š"ä»Šå¤©æœ‰ä»€ä¹ˆæ–°é—»ï¼Ÿ"
â†’ AI è°ƒç”¨ï¼šget_recent_news(hours=24)

ç”¨æˆ·é—®ï¼š"æœ€æ–°çš„ GPT-5 æ¶ˆæ¯æ˜¯ä»€ä¹ˆï¼Ÿ"
â†’ AI è°ƒç”¨ï¼šweb_search(query="GPT-5 latest news")
```

## API ç«¯ç‚¹

### POST /api/v1/assistant/chat-rag

å¯ç”¨ RAG çš„èŠå¤©ç«¯ç‚¹ã€‚

**è¯·æ±‚ï¼š**
```json
{
  "messages": [
    {"role": "user", "content": "æˆ‘æœ‰å“ªäº›å…³äºäººå·¥æ™ºèƒ½çš„æ–°é—»ï¼Ÿ"}
  ],
  "stream": true
}
```

**å“åº”ï¼ˆæµå¼ï¼‰ï¼š**
```
data: {"type": "delta", "content": "[ğŸ” æ­£åœ¨search_user_news...]"}
data: {"type": "delta", "content": "æˆ‘æ‰¾åˆ°äº† 5 æ¡å…³äºäººå·¥æ™ºèƒ½çš„æ–°é—»ï¼š\n\n"}
data: {"type": "delta", "content": "1. **OpenAI å‘å¸ƒ GPT-5**\n"}
data: {"type": "delta", "content": "   æ¥æºï¼šTechCrunch\n"}
data: {"type": "delta", "content": "   é“¾æ¥ï¼šhttps://...\n\n"}
data: {"type": "done"}
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæŸ¥è¯¢ç”¨æˆ·æ–°é—»åº“

```
ç”¨æˆ·ï¼šæˆ‘æœ‰å“ªäº›å…³äºåŒºå—é“¾çš„æ–‡ç« ï¼Ÿ

AI æ€è€ƒï¼šç”¨æˆ·æƒ³æŸ¥è¯¢ä»–çš„æ–°é—»åº“
AI è°ƒç”¨ï¼šsearch_user_news(query="åŒºå—é“¾", limit=5)

ç³»ç»Ÿè¿”å›ï¼š
{
  "total": 12,
  "results": [
    {
      "title": "æ¯”ç‰¹å¸çªç ´ 10 ä¸‡ç¾å…ƒ",
      "url": "https://...",
      "source": "CoinDesk",
      "score": 0.95
    },
    ...
  ]
}

AI å›å¤ï¼š
"æˆ‘åœ¨ä½ çš„æ–°é—»åº“ä¸­æ‰¾åˆ°äº† 12 æ¡å…³äºåŒºå—é“¾çš„æ–‡ç« ï¼Œä»¥ä¸‹æ˜¯æœ€ç›¸å…³çš„ 5 æ¡ï¼š

1. **æ¯”ç‰¹å¸çªç ´ 10 ä¸‡ç¾å…ƒ**
   æ¥æºï¼šCoinDesk
   é“¾æ¥ï¼šhttps://...

2. **ä»¥å¤ªåŠ 2.0 å‡çº§å®Œæˆ**
   æ¥æºï¼šEthereum.org
   é“¾æ¥ï¼šhttps://...

éœ€è¦æˆ‘æ€»ç»“è¿™äº›æ–‡ç« å—ï¼Ÿ"
```

### åœºæ™¯ 2ï¼šè·å–æœ€è¿‘æ–°é—»

```
ç”¨æˆ·ï¼šä»Šå¤©æœ‰ä»€ä¹ˆé‡è¦æ–°é—»ï¼Ÿ

AI æ€è€ƒï¼šç”¨æˆ·æƒ³çœ‹æœ€è¿‘çš„æ–°é—»
AI è°ƒç”¨ï¼šget_recent_news(hours=24, limit=10)

ç³»ç»Ÿè¿”å›ï¼š
{
  "count": 8,
  "results": [...]
}

AI å›å¤ï¼š
"ä»Šå¤©ä½ çš„æ–°é—»åº“æ›´æ–°äº† 8 æ¡æ–°é—»ï¼š

ğŸ“° ç§‘æŠ€ç±»ï¼ˆ3 æ¡ï¼‰
- OpenAI å‘å¸ƒæ–°æ¨¡å‹
- è‹¹æœå‘å¸ƒ iPhone 16
- ç‰¹æ–¯æ‹‰è‡ªåŠ¨é©¾é©¶æ›´æ–°

ğŸ’¼ è´¢ç»ç±»ï¼ˆ3 æ¡ï¼‰
- ç¾è”å‚¨é™æ¯ 0.25%
- æ¯”ç‰¹å¸çªç ´æ–°é«˜
- é˜¿é‡Œå·´å·´è´¢æŠ¥è¶…é¢„æœŸ

ğŸŒ å›½é™…ç±»ï¼ˆ2 æ¡ï¼‰
- ...

éœ€è¦æˆ‘è¯¦ç»†ä»‹ç»æŸæ¡æ–°é—»å—ï¼Ÿ"
```

### åœºæ™¯ 3ï¼šæ··åˆæ£€ç´¢

```
ç”¨æˆ·ï¼šGPT-5 å‘å¸ƒäº†å—ï¼Ÿæˆ‘çš„æ–°é—»åº“é‡Œæœ‰ç›¸å…³æ¶ˆæ¯å—ï¼Ÿ

AI æ€è€ƒï¼š
1. å…ˆæŸ¥ç”¨æˆ·æ–°é—»åº“
2. å¦‚æœæ²¡æœ‰ï¼Œå†æœç´¢ç½‘ç»œ

AI è°ƒç”¨ 1ï¼šsearch_user_news(query="GPT-5")
ç³»ç»Ÿè¿”å›ï¼š{"total": 0, "results": []}

AI è°ƒç”¨ 2ï¼šweb_search(query="GPT-5 release")
ç³»ç»Ÿè¿”å›ï¼š
{
  "count": 5,
  "results": [
    {
      "title": "OpenAI Announces GPT-5",
      "url": "https://...",
      "description": "..."
    }
  ]
}

AI å›å¤ï¼š
"ä½ çš„æ–°é—»åº“ä¸­è¿˜æ²¡æœ‰å…³äº GPT-5 çš„æ¶ˆæ¯ã€‚

æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†æœ€æ–°ä¿¡æ¯ï¼š

ğŸ”¥ **OpenAI Announces GPT-5**
æ¥æºï¼šOpenAI Blog
å‘å¸ƒæ—¶é—´ï¼š2 å°æ—¶å‰
é“¾æ¥ï¼šhttps://...

ä¸»è¦å†…å®¹ï¼š
- GPT-5 å°†äºä¸‹æœˆå‘å¸ƒ
- æ€§èƒ½æå‡ 10 å€
- æ”¯æŒå¤šæ¨¡æ€è¾“å…¥

éœ€è¦æˆ‘æŠŠè¿™æ¡æ–°é—»ä¿å­˜åˆ°ä½ çš„åº“å—ï¼Ÿ"
```

### åœºæ™¯ 4ï¼šæ·±åº¦åˆ†æ

```
ç”¨æˆ·ï¼šåˆ†æä¸€ä¸‹æˆ‘æœ€è¿‘å…³æ³¨çš„ç§‘æŠ€è¶‹åŠ¿

AI æ€è€ƒï¼šéœ€è¦è·å–ç”¨æˆ·çš„ç§‘æŠ€ç±»æ–°é—»å¹¶åˆ†æ

AI è°ƒç”¨ 1ï¼šsearch_user_news(query="ç§‘æŠ€", limit=20)
ç³»ç»Ÿè¿”å›ï¼š20 æ¡ç§‘æŠ€æ–°é—»

AI è°ƒç”¨ 2ï¼šget_recent_news(hours=168, limit=50)  # æœ€è¿‘ä¸€å‘¨
ç³»ç»Ÿè¿”å›ï¼š50 æ¡æ–°é—»

AI åˆ†æå¹¶å›å¤ï¼š
"åŸºäºä½ æœ€è¿‘ä¸€å‘¨çš„ 50 æ¡æ–°é—»ï¼Œæˆ‘å‘ç°äº†ä»¥ä¸‹ç§‘æŠ€è¶‹åŠ¿ï¼š

ğŸ“Š **ä¸»è¦å…³æ³¨é¢†åŸŸ**
1. äººå·¥æ™ºèƒ½ï¼ˆ35%ï¼‰- 18 æ¡æ–°é—»
   - GPT ç³»åˆ—æ¨¡å‹
   - AI èŠ¯ç‰‡
   - è‡ªåŠ¨é©¾é©¶

2. åŒºå—é“¾ï¼ˆ25%ï¼‰- 13 æ¡æ–°é—»
   - æ¯”ç‰¹å¸ä»·æ ¼
   - DeFi åº”ç”¨
   - NFT å¸‚åœº

3. ç¡¬ä»¶ï¼ˆ20%ï¼‰- 10 æ¡æ–°é—»
   - æ–°æ¬¾æ‰‹æœº
   - èŠ¯ç‰‡æŠ€æœ¯
   - é‡å­è®¡ç®—

ğŸ”¥ **çƒ­ç‚¹è¯é¢˜**
- OpenAI æ–°æ¨¡å‹ï¼ˆ8 æ¡ï¼‰
- è‹¹æœæ–°å“å‘å¸ƒï¼ˆ5 æ¡ï¼‰
- æ¯”ç‰¹å¸çªç ´æ–°é«˜ï¼ˆ4 æ¡ï¼‰

ğŸ“ˆ **è¶‹åŠ¿åˆ†æ**
ä½ å¯¹ AI çš„å…³æ³¨åº¦åœ¨ä¸Šå‡ï¼Œæœ€è¿‘ä¸€å‘¨å¢åŠ äº† 40%ã€‚
å»ºè®®è®¢é˜…æ›´å¤š AI ç›¸å…³çš„æ–°é—»æºã€‚

éœ€è¦æˆ‘æ¨èä¸€äº› AI æ–°é—»æºå—ï¼Ÿ"
```

## å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æé—®   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI åˆ†æé—®é¢˜ç±»å‹    â”‚
â”‚  - æŸ¥è¯¢æ–°é—»åº“ï¼Ÿ     â”‚
â”‚  - è·å–æœ€è¿‘æ–°é—»ï¼Ÿ   â”‚
â”‚  - æœç´¢ç½‘ç»œï¼Ÿ       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI å†³å®šè°ƒç”¨å·¥å…·    â”‚
â”‚  - search_user_news â”‚
â”‚  - get_recent_news  â”‚
â”‚  - web_search       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿæ‰§è¡Œå·¥å…·è°ƒç”¨   â”‚
â”‚  - ES æ··åˆæœç´¢      â”‚
â”‚  - MongoDB æŸ¥è¯¢     â”‚
â”‚  - Tavily API       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI åˆ†ææ£€ç´¢ç»“æœ    â”‚
â”‚  - æå–å…³é”®ä¿¡æ¯     â”‚
â”‚  - ç»¼åˆå¤šä¸ªæ¥æº     â”‚
â”‚  - ç”Ÿæˆå›ç­”         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ç­”æ¡ˆç»™ç”¨æˆ·     â”‚
â”‚  - å¼•ç”¨æ¥æº         â”‚
â”‚  - æä¾›é“¾æ¥         â”‚
â”‚  - å»ºè®®åç»­æ“ä½œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯å®ç°

### 1. Elasticsearch æ··åˆæœç´¢

```python
# å…³é”®è¯æœç´¢ï¼ˆBM25ï¼‰
{
  "query": {
    "multi_match": {
      "query": "äººå·¥æ™ºèƒ½",
      "fields": ["title^2", "description", "content"]
    }
  }
}

# è¯­ä¹‰æœç´¢ï¼ˆå‘é‡ï¼‰
{
  "knn": {
    "field": "embedding",
    "query_vector": [0.1, 0.2, ...],  # 768 ç»´
    "k": 10,
    "num_candidates": 100
  }
}

# æ··åˆæœç´¢ï¼ˆRRFï¼‰
# ç»“åˆä¸¤ç§æœç´¢ç»“æœï¼Œä½¿ç”¨ Reciprocal Rank Fusion
```

### 2. Function Calling

```python
tools = [
    {
        "type": "function",
        "function": {
            "name": "search_user_news",
            "description": "æœç´¢ç”¨æˆ·çš„æ–°é—»åº“",
            "parameters": {...}
        }
    }
]

# AI è‡ªä¸»å†³å®šè°ƒç”¨
response = await client.chat.completions.create(
    model="gpt-5.2",
    messages=messages,
    tools=tools,
    tool_choice="auto"  # AI è‡ªå·±å†³å®š
)

# å¦‚æœ AI å†³å®šè°ƒç”¨å·¥å…·
if response.tool_calls:
    for tool_call in response.tool_calls:
        result = execute_tool(tool_call)
        # å°†ç»“æœæ·»åŠ åˆ°å¯¹è¯
        messages.append({
            "role": "tool",
            "content": json.dumps(result)
        })
```

### 3. å¤šè½®å¯¹è¯

```python
max_iterations = 5  # æœ€å¤š 5 è½®

for i in range(max_iterations):
    response = await llm.chat(messages, tools=tools)

    if not response.tool_calls:
        # AI ä¸éœ€è¦æ›´å¤šä¿¡æ¯ï¼Œè¿”å›ç­”æ¡ˆ
        return response.content

    # AI éœ€è¦è°ƒç”¨å·¥å…·
    for tool_call in response.tool_calls:
        result = execute_tool(tool_call)
        messages.append(tool_result)

    # ç»§ç»­ä¸‹ä¸€è½®
```

## ä¼˜åŠ¿

### vs ä¼ ç»ŸèŠå¤©æœºå™¨äºº

| ç‰¹æ€§ | ä¼ ç»ŸèŠå¤© | RAG åŠ©æ‰‹ |
|------|---------|----------|
| çŸ¥è¯†æ¥æº | è®­ç»ƒæ•°æ® | å®æ—¶æ£€ç´¢ |
| ä¿¡æ¯æ—¶æ•ˆæ€§ | è¿‡æ—¶ | æœ€æ–° |
| ä¸ªæ€§åŒ– | æ—  | åŸºäºç”¨æˆ·æ•°æ® |
| å¯éªŒè¯æ€§ | ä½ | é«˜ï¼ˆæä¾›æ¥æºï¼‰|
| å¹»è§‰é—®é¢˜ | ä¸¥é‡ | å¤§å¹…å‡å°‘ |

### vs å›ºå®š RAG

| ç‰¹æ€§ | å›ºå®š RAG | è‡ªä¸» RAG |
|------|---------|----------|
| æ£€ç´¢æ—¶æœº | æ¯æ¬¡éƒ½æ£€ç´¢ | AI å†³å®š |
| æ£€ç´¢æ¥æº | å•ä¸€ | å¤šæºï¼ˆES/MongoDB/Webï¼‰|
| æ•ˆç‡ | ä½ | é«˜ |
| çµæ´»æ€§ | ä½ | é«˜ |

## é…ç½®è¦æ±‚

### å¿…éœ€
- âœ… Elasticsearchï¼ˆå·²é…ç½®ï¼‰
- âœ… MongoDBï¼ˆå·²é…ç½®ï¼‰
- âœ… å‘é‡åµŒå…¥æ¨¡å‹ï¼ˆå·²é…ç½®ï¼‰
- âœ… OpenAI APIï¼ˆå·²é…ç½®ï¼‰

### å¯é€‰
- âœ… Tavily APIï¼ˆå·²é…ç½®ï¼‰- ç”¨äºå¤–éƒ¨æœç´¢

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
```python
# ç¼“å­˜å¸¸è§æŸ¥è¯¢
@lru_cache(maxsize=100)
async def search_cache(query: str, user_id: str):
    return await search_user_news(query, user_id)
```

### 2. å¹¶è¡Œæ£€ç´¢
```python
# åŒæ—¶æœç´¢å¤šä¸ªæ¥æº
results = await asyncio.gather(
    search_user_news(query),
    get_recent_news(),
    web_search(query)
)
```

### 3. ç»“æœé‡æ’åº
```python
# ä½¿ç”¨ RRF èåˆå¤šä¸ªæ¥æºçš„ç»“æœ
def rrf_merge(results_list, k=60):
    scores = {}
    for rank, item in enumerate(results):
        scores[item.url] = 1 / (k + rank + 1)
    return sorted(scores, key=scores.get, reverse=True)
```

## ç›‘æ§å’Œå®¡è®¡

æ‰€æœ‰ RAG æ“ä½œéƒ½ä¼šè¢«è®°å½•ï¼š

```python
{
    "user_id": "...",
    "action": "rag_chat",
    "input_summary": "ç”¨æˆ·é—®é¢˜...",
    "output_summary": "AI å›ç­”...",
    "model": "gpt-5.2",
    "latency_ms": 1234,
    "quality_signals": {
        "tool_calls": ["search_user_news", "web_search"],
        "iterations": 2,
        "sources_used": 3
    }
}
```

## ä¸‹ä¸€æ­¥

1. **å‰ç«¯é›†æˆ**
   - ä¿®æ”¹ AssistantView ä½¿ç”¨ `/chat-rag` ç«¯ç‚¹
   - æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
   - å±•ç¤ºæ¥æºå¼•ç”¨

2. **å¢å¼ºåŠŸèƒ½**
   - æ·»åŠ ä¿å­˜æ–°é—»å·¥å…·
   - æ·»åŠ æ ‡ç­¾ç®¡ç†å·¥å…·
   - æ·»åŠ æºç®¡ç†å·¥å…·

3. **ä¼˜åŒ–**
   - å®ç°æŸ¥è¯¢ç¼“å­˜
   - ä¼˜åŒ–æ£€ç´¢é€Ÿåº¦
   - æ”¹è¿›ç»“æœæ’åº

## æ€»ç»“

RAG AI åŠ©æ‰‹é€šè¿‡è‡ªä¸»æ£€ç´¢å’Œå¤šæºèåˆï¼Œè§£å†³äº†ä¼ ç»ŸèŠå¤©æœºå™¨äººçš„æ ¸å¿ƒé—®é¢˜ï¼š

- âœ… ä¸å†"åªä¼šè¯´è¯"
- âœ… èƒ½è®¿é—®ç”¨æˆ·çš„æ–°é—»æ•°æ®
- âœ… èƒ½è·å–æœ€æ–°ä¿¡æ¯
- âœ… æä¾›å¯éªŒè¯çš„æ¥æº
- âœ… å¤§å¹…å‡å°‘å¹»è§‰

è¿™å°±æ˜¯ä½ æƒ³è¦çš„"åˆ©ç”¨ ES è‡ªå·±å»åš RAG"çš„å®Œæ•´å®ç°ï¼
